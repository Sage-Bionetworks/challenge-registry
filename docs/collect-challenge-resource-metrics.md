# Collecting Challenge Resource Metrics

## Overview

This document describes how to centralize the logs and compute resource usage information generated by a fleet of EC2 instances.

The collected data aim to answer the following questions:

- Are all the EC2 instances up?
- Is an instance at risk of crashing because its storage capacity is nearly filled up?
- Are submissions using all the CPU cores available?
- Are submissions using the GPU cores available?
- Is a submission crashing due to a memory leak (memory usage, logs)?
- Is a submission generating too much data (logs, scratch/pre-processed/output files)
- What fraction of the uptime of an EC2 instance is used to process submissions?
  - How much money could we have saved using on-demand EC2 instances?

## Architecture

- 1 EC2 instance that runs the [ELK stack].
- N EC2 instances that run Beat agents (Metricbeat, Filebeat).

## Deploy the ELK Stack

- Create an EC2 instance in the AWS account `CnbAccount` with the following specifications:
  - Name and tags:
    - Name: `<challenge name>-elk` (e.g. `ptb-challenge-elk`)
    - Tags:
      - `Department`: `CNB`
      - `Project`: XXX
      - `CostCenter`: XXX
  - Application and OS Images (Amazon Machine Image):
    - Amazon Machine Image (AMI): `Ubuntu Server 22.04 LTS (HVM), SSD Volume Type`
    - Architecture: `64-bit (x86)`
  - Instance type: `t2.medium`
    - The instance requires at least 2 vCPUs and 4 GB of memory.
  - Network settings:
    - TODO
    - IAM Role: `AmazonSSMRoleForInstancesQuickSetup`
    - Security groups:
      - `sg-0807a0e374542affd (cnbvpc-VpnSecurityGroup-JBXT9AUVDXCA)`
  - Configure storage
    - 1x 100 GB gp2
  - Storage space: 100 GB
- Ssh to the EC2 instance.
- Update the system packages.
   ```console
   sudo apt update
   sudo apt upgrade -y
   ```
- [Install the Docker Engine].
  - [Enable the non-root user to execute Docker commands].
  - Make sure that the Docker Engine starts at startup.
    ```console
    sudo systemctl enable docker
    ```
- Update the hostname of the EC2 instance
  - Open the file `/etc/hostname`
  - Set the hostname to `<challenge name>-elk`
- Reboot to apply the new hostname and Docker configuration.
- Clone the repository [Sage-Bionetworks/docker-elk] in the home directory.
- Configure the ELK stack.
  - [Disable paid features](https://github.com/Sage-Bionetworks/docker-elk#how-to-disable-paid-features)
  - Set new passwords in `.env`.
- Start the ELK stack.
   ```console
   docker compose up -d
   ```
- Give Kibana about 2-3 minutes to initialize, then access the Kibana web UI by opening
  `http://<public ip>:5601` in a web browser and use the following (default) credentials to log in:
  - user: `elastic`
  - password: `<elastic_password>`

## Deploy Metricbeat




```console
$ sudo metricbeat setup -e
...
Index setup finished.
Loading dashboards (Kibana must be running and reachable)
{"log.level":"info","@timestamp":"2022-07-19T00:07:29.869Z","log.logger":"kibana","log.origin":{"file.name":"kibana/client.go","file.line":179},"message":"Kibana url: http://10.255.22.107:5601","service.name":"metricbeat","ecs.version":"1.6.0"}
{"log.level":"info","@timestamp":"2022-07-19T00:07:30.541Z","log.logger":"kibana","log.origin":{"file.name":"kibana/client.go","file.line":179},"message":"Kibana url: http://10.255.22.107:5601","service.name":"metricbeat","ecs.version":"1.6.0"}
{"log.level":"info","@timestamp":"2022-07-19T00:09:25.347Z","log.origin":{"file.name":"instance/beat.go","file.line":882},"message":"Kibana dashboards successfully loaded.","service.name":"metricbeat","ecs.version":"1.6.0"}
Loaded dashboards
```

Start Metricbeat and check its status.

```console
sudo systemctl start metricbeat
sudo systemctl status metricbeat
```

Finally, use the `enable` command to ensure that the service starts whenever the system boots.

```console
$ sudo systemctl enable metricbeat
Created symlink from /etc/systemd/system/multi-user.target.wants/metricbeat.service to /usr/lib/systemd/system/metricbeat.service.
```



The Beat `Nvidiagpubeat` only support ELK v6 and v7. We are currently using ELK v8.3.0.

https://github.com/eBay/nvidiagpubeat

We could write our own Beat:

- https://www.elastic.co/guide/en/beats/libbeat/current/community-beats.html

<!-- Links -->

[ELK stack]: https://www.elastic.co/what-is/elk-stack
[deviantony/docker-elk]: https://github.com/deviantony/docker-elk
[Sage-Bionetworks/docker-elk]: https://github.com/Sage-Bionetworks/docker-elk
[Install the Docker Engine]: https://docs.docker.com/engine/install/ubunt
[Enable the non-root user to execute Docker commands]: https://docs.docker.com/engine/install/linux-postinstall/#manage-docker-as-a-non-root-user

